---
# tasks file for vmware_vm_manager

- name: "Check if vm exists"
  block:
    - name: "Gathering vm info"
      community.vmware.vmware_guest_info:
        hostname: "{{ vmware_vm_manager_hostname | default(lookup('ansible.builtin.env', 'VMWARE_HOST')) }}"
        username: "{{ vmware_vm_manager_username | default(lookup('ansible.builtin.env', 'VMWARE_USER')) }}"
        password: "{{ vmware_vm_manager_password | default(lookup('ansible.builtin.env', 'VMWARE_PASSWORD')) }}"
        port: "{{ vmware_vm_manager_port | default(lookup('ansible.builtin.env', 'VMWARE_PORT')) }}"
        validate_certs: "{{ vmware_vm_manager_validate_certs | default(lookup('ansible.builtin.env', 'VMWARE_VALIDATE_CERTS')) }}"
        proxy_host: "{{ vmware_vm_manager_proxy_host | default(lookup('ansible.builtin.env', 'VMWARE_PROXY_HOST')) }}"
        proxy_port: "{{ vmware_vm_manager_proxy_port | default(lookup('ansible.builtin.env', 'VMWARE_PROXY_PORT')) | int }}"
        datacenter: "{{ vmware_vm_manager_datacenter | mandatory }}"
        name: "{{ vmware_vm_manager_name | mandatory }}"
      register: "vmware_vm_manager_info"
      ignore_errors: true

    # - name: "DEBUG: \"Print vm info\""
    #   ansible.builtin.debug:
    #     msg: "{{ vmware_vm_manager_info['failed'] }}"

    - name: "Assert that vm not exists inside datacenter"
      ansible.builtin.assert:
        that:
          - vmware_vm_manager_info['failed']
        fail_msg: "{{ vmware_vm_manager_name }} vm exists inside the {{ vmware_vm_manager_datacenter }} datacenter, please check it before to continue"
        success_msg: "{{ vmware_vm_manager_name }} not exists inside the {{ vmware_vm_manager_datacenter }} datacenter."

- name: "Clone a virtual machine from template"
  community.vmware.vmware_guest:
    hostname: "{{ vmware_vm_manager_hostname | default(lookup('ansible.builtin.env', 'VMWARE_HOST')) }}"
    username: "{{ vmware_vm_manager_username | default(lookup('ansible.builtin.env', 'VMWARE_USER')) }}"
    password: "{{ vmware_vm_manager_password | default(lookup('ansible.builtin.env', 'VMWARE_PASSWORD')) }}"
    port: "{{ vmware_vm_manager_port | default(lookup('ansible.builtin.env', 'VMWARE_PORT')) }}"
    validate_certs: "{{ vmware_vm_manager_validate_certs | default(lookup('ansible.builtin.env', 'VMWARE_VALIDATE_CERTS')) }}"
    proxy_host: "{{ vmware_vm_manager_proxy_host | default(lookup('ansible.builtin.env', 'VMWARE_PROXY_HOST')) }}"
    proxy_port: "{{ vmware_vm_manager_proxy_port | default(lookup('ansible.builtin.env', 'VMWARE_PROXY_PORT')) | int }}"
    datacenter: "{{ vmware_vm_manager_datacenter | mandatory }}"
    cluster: "{{ vmware_vm_manager_cluster if vmware_vm_manager_cluster is defined and vmware_vm_manager_esxi_hostname is not defined else omit }}"
    esxi_hostname: "{{ vmware_vm_manager_esxi_hostname if vmware_vm_manager_esxi_hostname is defined and vmware_vm_manager_cluster is not defined else omit }}"
    datastore: "{{ vmware_vm_manager_datastore if vmware_vm_manager_datastore is defined else omit }}"
    folder: "{{ vmware_vm_manager_folder if vmware_vm_manager_folder is defined else omit }}"
    name: "{{ vmware_vm_manager_name | mandatory }}"
    annotation: "{{ vmware_vm_manager_annotation | default(omit) }}"
    state: "{{ vmware_vm_manager_state | default(omit) }}"
    template: "{{ vmware_vm_manager_template if vmware_vm_manager_template is defined else omit }}"
    disk: "{{ vmware_vm_manager_disk | default(omit) }}"
    hardware: "{{ vmware_vm_manager_hardware | default(omit) }}"
    networks: "{{ vmware_vm_manager_networks | mandatory }}"
    force: "{{ vmware_vm_manager_force | default(omit) }}"
    convert: "{{ vmware_vm_manager_convert | default(omit) }}"
    guest_id: "{{ vmware_vm_guest_id if vmware_vm_guest_id is defined and vmware_vm_template is not defined else omit }}"
    use_instance_uuid: "{{ vmware_vm_manager_use_instance_uuid | default(omit) }}"
    # vmware_vm_manager_linked_clone: "{{ vmware_vm_manager_linked_clone }}"
    # state_change_timeout: "{{ vmware_vm_manager_state_change_timeout }}"
    # resource_pool: "{{ vmware_vm_manager_resource_pool }}"
    # is_template: "{{ vmware_vm_manager_is_template }}"
    # snapshot_src: "{{ _vmware_vm_manager_snapshot_src }}"
    # name_match: "{{ vmware_vm_manager_name_match }}"
    # nvdimm : "{{ vmware_vm_manager_nvdimm }}"
    # vaap_properties: "{{ vmware_vm_manager_vaap_properties }}"
    # encryption: "{{ vmware_vm_manager_encryption }}"
    # wait_for_ip_address: true
    # customization: "{{ vmware_vm_manager_customization | default(omit) }}"
    #   domain: "{{ guest_domain }}"
    #   dns_servers:
    #     - 8.9.9.9
    #     - 7.8.8.9
    #   dns_suffix:
    #     - example.com
    #     - example2.com
    #   script_text: |
    #     #!/bin/bash
    #     touch /tmp/touch-from-playbook
        # cdrom:
        # - controller_number: 0
        #   unit_number: 0
        #   state: present
        #   type: iso
        #   iso_path: "[datastore1] livecd.iso"
    # wait_for_customization: "{{ vmware_vm_manager_wait_for_customization }}"
    # wait_for_customization_timeout: "{{ vmware_vm_manager_wait_for_customization_timeout }}"
...
